---
title: "Introduction to sobekio - Draft"
author: "D. Quang Duong"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to sobekio}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sobekio)
```

# List of function in sobekio package

Development is currently for output, input was written but not yet tested.

| Nr. | Function        | Description                                                                                                                                                                                                                                                                                                                                              |   |   |
|-----|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---|---|
| 1   | his_info        | Get the basic information of a .his file. Return a list with                                                                                                                                                                                                                                                                                             |   |   |
| 2   | his_location    | Get the location table from a .his file. Return a data.table with two column: location (the index), and sobek.id. Sobek.id is id of elements (node/reach)... in Sobek Network written in the file. Sobek.id are trimmed to only max. 20 characters. If there is a relevant .hia file, a long.id column with be added, this contains full name of the id. |   |   |
| 3   | his_from_list   | Get the values of sobek.id(s) from a .his file. The ids must be given as a, or can be unlist() to one, character vector.                                                                                                                                                                                                                                 |   |   |
| 4   | his_from_file   | Get the values of sobek.id(s) from a .his file. The ids are listed in a file, with path to the file given as input.                                                                                                                                                                                                                                      |   |   |
| 5   | his_from_case   | Get values from sobek.id(s) for multiple Sobek cases, like his_single_case but the case.list can be more flexible. Actually, the function can replace his_single_case                                                                                                                                                                                    |   |   |
| 6   | sobek_case_info | Get information for a single Sobek case. It gets his_info or his_location for different .his files (calcpnt.his, reachseg.his...) of the case                                                                                                                                                                                                            |   |   |
| 7   | get_file_path | Get path to a file from case.name and sobek.project. File type can be (node, reach, lateral, setting, boundary, control, casedesc)                                                                                                                                                                                                           |   |   |

```{r include=FALSE}
so_prj <- "d:/so21302/rhein29a.lit"
# case list as list
case_list <- c('2013_Basis_V6_hist_HW1988_lubw180830_mittel',
          '2013_Basis_V6_hist_HW1988_lubw180830_selten',
          '2013_Basis_V6_hist_HW1995_lubw180830_selten',
          '2013_Basis_V6_hist_HW2003_lubw180830_mittel',
          '2013_Basis_V6_hist_HW2003_lubw180830_selten')
# single his.file
hfile <- "d:/so21302/rhein29a.lit/200/reachseg.his"
# list of qid
qid_list <- c("46", "176", "Rhe_528.95_3929_Rhe_" )
# file to qid
qid_file <- "D:/Users/Duong/Documents/sobekio/tmp/qids.txt"
wid_file <- "D:/Users/Duong/Documents/sobekio/tmp/wids.txt"
```

# Functions
## Function `his_info`


```{r}
his_info(hfile)
```
## Function `his_location`
This function is useful for getting a table of all IDs in a his file, for testing or verification.
```{r}
hfile_loc <- his_location(hfile)
head(hfile_loc)
```

## Function `his_from_list`

If Sobek IDs are already in a vector, and path to .HIS file is known, this function will read data of the IDs for a specific parameter. \n
The path to his file of a case can be acquired using the function `get_file_path`

```{r}
# does not work
his_list <- his_from_list(his.file = hfile,
                          id.list = qid_file,
                          param = "discharge")
```

```{r}
# work
his_list <- his_from_list(his.file = hfile,
                          id.list = qid_list,
                          param = "discharge")
head(his_list)
```


As seen above, the function returns a data.table with the first column is time series (ts). Other columns are data of the sobek.id given in the id.list. Parameter can be given by name, or by an index. By giving parameter as an index, be carefull with the parameter ordering. It can be check with the his_info or sobek_case_info function.

### Performance

How long does it take to get data for all nodes from a his file containing 3014 nodes and 374 time steps?


```{r}
system.time(hlist1 <- his_from_list(his.file = hfile,
                          id.list = hfile_loc$sobek.id,
                          param = "discharge"
                          )
            )

```

It takes less than a second to read data for more than 3000 ids from a .HIS file. Parameter `param` can be given as a number (index) or as a string (name). If the parameter is not found, a message will be displayed with a table of available parameters stored in the .HIS file.

```{r eval=FALSE}
his_from_list(his.file = hfile,
                          id.list = hfile_loc$sobek.id,
                          param = "dischargeNo"
                          )
```

## Function `his_from_case`

This is the most useful function, getting results from one or more Sobek cases, with Sobek IDs given as a list, a path to a file or a data.frame (data.table). If IDs are stored in a file, the file should have one or 2 columns, first column is for the IDs, second column for the names, they are used as column names in the output table.

Cases can be given also as a list or a path to a file contain list of cases, one line for one case.

Commenting character, header, or column seperation in the file can be given.

Output of this function will be a data.table if only one type of IDs (i.e. qID or wID) was given, or a list of data.table if more than one types of IDs were given.

### case input as list & qID also as list

```{r}
system.time(his_case <- his_from_case(case.list = case_list,
                          sobek.project = so_prj,
                          qID = qid_list))
head(his_case)
```


